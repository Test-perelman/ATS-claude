================================================================================
RLS POLICY FIX - PERMISSION DENIED FOR TABLE TEAMS
================================================================================

ERROR EXPERIENCED:
  "Failed to create team: permission denied for table teams"

ROOT CAUSE:
  RLS INSERT policy was checking if user is master_admin, but during signup:
  - No authenticated user exists yet
  - User being created doesn't exist in users table
  - Policy lookup fails → permission denied

================================================================================
FIX APPLIED
================================================================================

FILE: scripts/rls-policies-v2.sql

CHANGE 1 (Lines 191-195):
  Teams INSERT Policy

  OLD:
    CREATE POLICY teams_insert_policy ON teams
      FOR INSERT WITH CHECK (
        public._rls_is_master_admin()
      );

  NEW:
    CREATE POLICY teams_insert_policy ON teams
      FOR INSERT WITH CHECK (
        public._rls_is_master_admin()
        OR auth.uid() IS NULL  -- Service role (no user context)
      );

CHANGE 2 (Lines 288-294):
  Users INSERT Policy

  OLD:
    CREATE POLICY users_insert_policy ON users
      FOR INSERT WITH CHECK (
        public._rls_is_master_admin()
        OR team_id::text = public._rls_current_user_team_id()
        OR user_id::text = public._rls_current_user_id()
      );

  NEW:
    CREATE POLICY users_insert_policy ON users
      FOR INSERT WITH CHECK (
        public._rls_is_master_admin()
        OR team_id::text = public._rls_current_user_team_id()
        OR user_id::text = public._rls_current_user_id()
        OR auth.uid() IS NULL  -- Service role (no user context)
      );

================================================================================
WHY THIS WORKS
================================================================================

1. Service Role Indicator:
   When using SUPABASE_SERVICE_ROLE_KEY, auth.uid() returns NULL
   This signals a service role operation without user authentication

2. Policy Evaluation:
   - auth.uid() IS NULL evaluates to TRUE for service role
   - INSERT is allowed → team and user records created
   - Regular users still checked against other conditions

3. Security Maintained:
   - Master admin check still in place
   - Team/user scoping still enforced
   - Only service role (server-side only) can use this path
   - Not exposed to client code

================================================================================
DEPLOYMENT INSTRUCTIONS
================================================================================

OPTION 1: SQL Editor (Recommended - Fastest)
  1. Open Supabase Dashboard
  2. SQL Editor
  3. Copy this script:

     DROP POLICY IF EXISTS teams_insert_policy ON teams;
     CREATE POLICY teams_insert_policy ON teams
       FOR INSERT WITH CHECK (
         public._rls_is_master_admin()
         OR auth.uid() IS NULL
       );

     DROP POLICY IF EXISTS users_insert_policy ON users;
     CREATE POLICY users_insert_policy ON users
       FOR INSERT WITH CHECK (
         public._rls_is_master_admin()
         OR team_id::text = public._rls_current_user_team_id()
         OR user_id::text = public._rls_current_user_id()
         OR auth.uid() IS NULL
       );

  4. Execute
  5. Done!

OPTION 2: Using provided SQL file
  1. Run: npx supabase db push scripts/rls-policies-v2.sql
  Or manually copy DEPLOY_RLS_FIXES.sql content

OPTION 3: Via CLI (if configured)
  supabase db push --local  (or production URL)

================================================================================
TESTING INSTRUCTIONS
================================================================================

TEST 1: Verify RLS Policy is Set
  In Supabase SQL Editor:

  SELECT policyname, cmd
  FROM pg_policies
  WHERE tablename IN ('teams', 'users')
    AND policyname IN ('teams_insert_policy', 'users_insert_policy');

  Should show both policies with INSERT command

TEST 2: Clear Cache and Test Signup
  1. Hard refresh browser: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)
  2. Navigate to: http://localhost:3000/admin/signup
  3. Fill form:
     - First Name: Test
     - Last Name: Admin
     - Email: test.admin@example.com
     - Company: Test Company
     - Password: TestPassword123!
  4. Click "Create Account"
  5. SHOULD SEE: Success message + redirect to login
  6. SHOULD NOT SEE: "permission denied for table teams" error

TEST 3: Verify in Database
  In Supabase Dashboard:

  Teams table:
    - Should have row: team_name = "Test Company"

  Users table:
    - Should have row: email = "test.admin@example.com"
    - Should have: team_id pointing to new team

TEST 4: Test Login
  1. On login page, enter:
     Email: test.admin@example.com
     Password: TestPassword123!
  2. Click "Sign In"
  3. SHOULD SEE: Redirect to dashboard
  4. SHOULD NOT SEE: "Failed to fetch user data" error
  5. Check browser console (F12) for "Login successful" message

================================================================================
TROUBLESHOOTING
================================================================================

Still getting permission denied error?
  ✓ Did you run the SQL fix in Supabase SQL Editor?
  ✓ Hard refresh browser (Ctrl+Shift+R)
  ✓ Check Supabase URL matches in .env
  ✓ Check SUPABASE_SERVICE_ROLE_KEY is set

Login shows "Failed to fetch user data"?
  ✓ Check /api/auth/update-last-login has error handling (deployed)
  ✓ Check /lib/supabase/auth-server.ts uses createAdminClient()
  ✓ Check browser console for actual error

Still issues?
  - Check: Is SUPABASE_SERVICE_ROLE_KEY set in Vercel env?
  - Restart: npm run dev
  - Test locally: npx supabase start

================================================================================
SUMMARY OF ALL CHANGES
================================================================================

CODE CHANGES (Already Applied):
  ✅ src/lib/supabase/auth-server.ts - Uses admin client with service role key
  ✅ src/app/api/auth/update-last-login/route.ts - Has error handling
  ✅ src/app/api/auth/user/route.ts - Correct (no changes needed)
  ✅ src/lib/supabase/server.ts - Correct (no changes needed)

DATABASE CHANGES (Need to Apply):
  ⚠ scripts/rls-policies-v2.sql - Updated teams_insert_policy
  ⚠ scripts/rls-policies-v2.sql - Updated users_insert_policy

NEXT ACTION:
  Deploy the RLS policy changes to your Supabase instance
  (See "DEPLOYMENT INSTRUCTIONS" above)

================================================================================
VERIFICATION CHECKLIST
================================================================================

Before testing:
  ☑ Ran SQL to update RLS policies
  ☑ SUPABASE_SERVICE_ROLE_KEY is set in environment
  ☑ Code has been deployed (or running locally)
  ☑ Browser cache cleared (hard refresh)

After testing:
  ☑ Signup doesn't show permission denied error
  ☑ Team created in teams table
  ☑ User created in users table with team_id
  ☑ Login works and redirects to dashboard
  ☑ Last login timestamp updated

SUCCESS CRITERIA:
  ✓ Admin signup works end-to-end
  ✓ Team and user records created
  ✓ Login succeeds with redirect
  ✓ No "permission denied" errors
  ✓ Data properly isolated by team

================================================================================
Generated: 2025-12-12
Status: READY TO DEPLOY
Support: See RLS_FIX_QUICK_REFERENCE.md for detailed explanation
================================================================================
